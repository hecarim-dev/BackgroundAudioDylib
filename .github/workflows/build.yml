name: Build BackgroundAudioDylib (Auto-Signed Stable)

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 25

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup dependencies
        run: |
          set -eux
          sudo apt update -y
          sudo apt install -y wget curl tar unzip dpkg-dev fakeroot clang make perl build-essential libz-dev || true
          if ! command -v ldid >/dev/null 2>&1; then
            echo "‚ö†Ô∏è  ldid not found, skipping install"
          fi
          ldid -v || true

      - name: Download and prepare Theos
        run: |
          set -eux
          mkdir -p ~/theos_env && cd ~/theos_env

          wget -q --show-progress -O theos_env_full_backup.tar.gz \
            "https://github.com/hecarim-dev/theos-env-backup/releases/download/v1.0.0/theos_env_full_backup.tar.gz"

          tar -xzf theos_env_full_backup.tar.gz

          # T√¨m th∆∞ m·ª•c th·ª±c ch·ª©a makefiles/tweak.mk
          FOUND_PATH=$(find . -type f -path "*/makefiles/tweak.mk" | head -n1 || true)
          if [ -z "$FOUND_PATH" ]; then
            echo "‚ùå Kh√¥ng t√¨m th·∫•y tweak.mk trong g√≥i Theos!"
            find . -maxdepth 3 -type d
            exit 1
          fi

          THEOS_DIR=$(dirname "$(dirname "$FOUND_PATH")")
          echo "‚úÖ Found Theos directory: $THEOS_DIR"
          sudo rm -rf /opt/theos || true
          sudo mv "$THEOS_DIR" /opt/theos

          echo "üìÅ Theos content preview:"
          ls -R /opt/theos | head -n 30

      - name: Build tweak (.deb)
        env:
          THEOS: /opt/theos
          THEOS_MAKE_PATH: /opt/theos/makefiles
        run: |
          set -eux
          export THEOS=/opt/theos
          export THEOS_MAKE_PATH=/opt/theos/makefiles

          echo "üîç Checking Theos path..."
          ls -la $THEOS/makefiles || true
          [ -f $THEOS/makefiles/tweak.mk ] || (echo "‚ùå tweak.mk not found" && exit 1)

          cd $GITHUB_WORKSPACE
          make clean || true
          make package FINALPACKAGE=1

      - name: Extract dylib from .deb
        run: |
          set -eux
          mkdir -p output
          DEB=$(ls packages/*.deb 2>/dev/null | head -n1 || true)
          if [ -z "$DEB" ]; then
            echo "‚ùå No .deb file found"
            exit 1
          fi
          dpkg-deb -x "$DEB" tmp
          find tmp -name "*.dylib" -exec cp {} output/BackgroundAudio_ready4eSign.dylib \;
          if [ ! -f output/BackgroundAudio_ready4eSign.dylib ]; then
            echo "‚ùå No dylib extracted"
            find tmp -name "*.dylib"
            exit 1
          fi
          ls -lh output

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: BackgroundAudio_ready4eSign
          path: output/*.dylib
