name: Build Theos Tweak (.dylib auto extract â€“ stable v3)

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-22.04  # âš™ï¸ DÃ¹ng Ubuntu cÅ© hÆ¡n cho Theos tÆ°Æ¡ng thÃ­ch
    timeout-minutes: 15

    steps:
      - name: ğŸ“¦ Checkout source
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup environment & install deps
        run: |
          sudo apt update -y
          sudo apt install -y wget curl tar unzip dpkg-dev fakeroot clang make perl
          # ğŸ§© CÃ i ldid tá»« Procursus hoáº·c mirror thay tháº¿
          wget -q https://apt.procurs.us/dists/1800/main/binary-amd64/ldid_2.1.5-procursus4_amd64.deb -O /tmp/ldid.deb || \
          wget -q https://apt.procurs.us/dists/darwin/main/binary-amd64/ldid_2.1.5_amd64.deb -O /tmp/ldid.deb
          sudo dpkg -i /tmp/ldid.deb || true
          ldid -v || echo "âœ… Installed ldid successfully."

      - name: ğŸŒ Download Theos Environment
        run: |
          mkdir ~/theos_env
          cd ~/theos_env
          wget -q https://github.com/hecarim-dev/theos-env-backup/releases/download/v1.0.0/theos_env_full_backup.tar.gz
          tar -xzf theos_env_full_backup.tar.gz
          sudo mkdir -p /opt
          find . -type d -name "theos" -exec sudo mv {} /opt/theos \;
          echo "âœ… Theos structure:"
          ls -la /opt/theos

      - name: ğŸ› ï¸ Build tweak
        run: |
          export THEOS=/opt/theos
          export PATH=$THEOS/bin:$PATH
          echo "ğŸ”§ Using Theos from: $THEOS"
          make clean
          make FINALPACKAGE=1 || make

      - name: ğŸ¯ Extract dylib from .deb
        run: |
          mkdir -p output
          DEB_FILE=$(ls packages/*.deb | head -n 1)
          echo "ğŸ“¦ Found package: $DEB_FILE"
          dpkg-deb -x "$DEB_FILE" tmp_deb
          find tmp_deb -name "*.dylib" -exec cp {} output/ \;
          echo "âœ… Extracted dylibs:"
          ls -la output/

      - name: ğŸš€ Upload dylib artifact
        uses: actions/upload-artifact@v4
        with:
          name: Built-Dylibs
          path: output/*.dylib
